@page "/summary"
@using StoryForge.Application.Summary
@using StoryForge.Core.Data
@inject BreadCrumbHandler crumbHandler;
@inject ISender Sender;

<PageTitle>@Title</PageTitle>
<MudText Typo="Typo.h4" Class="mb-4">@Title</MudText>

<MudStack Spacing="2">
    <MudTextField @bind-Value="Situation" Label="Situation" Variant="Variant.Outlined" />
    <MudTabs Rounded="true" Centered="true">
        <MudTabPanel Text="Sentence" Class="pt-2">
            <MudTextField T="string" Value="@SentenceSummary" ValueChanged="SentenceUpdated" Label="One-Sentence Summary" Lines="2" Variant="Variant.Outlined" />
            <WordCountLabel WordCount="@SentenceWordCount" />
        </MudTabPanel>
        <MudTabPanel Text="Paragraph" Class="pt-2">
            <MudTextField T="string" Value="@ParagraphSummary" ValueChanged="ParagraphUpdated" Label="One-Paragraph Summary" Lines="8" Variant="Variant.Outlined" />
            <WordCountLabel WordCount="@ParagraphWordCount" />
        </MudTabPanel>
        <MudTabPanel Text="Page" Class="pt-2">
            <MudTextField T="string" Value="@PageSummary" ValueChanged="PageUpdated" Label="One-Page Summary" Lines="18" Variant="Variant.Outlined" />
            <WordCountLabel WordCount="@PageWordCount" />
        </MudTabPanel>
    </MudTabs>
</MudStack>

@code {
    const string Title = "Summary";

    string Situation
    {
        get => summaryData?.Situation ?? string.Empty;
        set
        {
            if (summaryData is null) return;
            summaryData.Situation = value;
            SaveData();
        }
    }

    string SentenceSummary
    {
        get => summaryData?.Sentence ?? string.Empty;
        set
        {
            if (summaryData is null) return;
            summaryData.Sentence = value;
            SaveData();
        }
    }

    string ParagraphSummary
    {
        get => summaryData?.Paragraph ?? string.Empty;
        set
        {
            if (summaryData is null) return;
            summaryData.Paragraph = value;
            SaveData();
        }
    }

    string PageSummary
    {
        get => summaryData?.Page ?? string.Empty;
        set
        {
            if (summaryData is null) return;
            summaryData.Page = value;
            SaveData();
        }
    }

    int SentenceWordCount { get; set; } = 0;
    int ParagraphWordCount { get; set; } = 0;
    int PageWordCount { get; set; } = 0;

    BookSummary? summaryData;

    protected override async Task OnInitializedAsync()
    {
        crumbHandler.Items.Clear();
        crumbHandler.Items.Add(new("Summary", "/summary", Icons.Material.Filled.Summarize));
        crumbHandler.NavigationChange?.Invoke();

        var summaryResult = await Sender.Send(new GetBookSummaryOperation());
        summaryData = summaryResult.Or(new BookSummary());

        SentenceWordCount = SentenceSummary.WordCount();
    }

    void SaveData()
    {
        if (summaryData is null) return;
        _ = Sender.Send(new UpdateBookSummaryOperation(summaryData));
    }

    void SentenceUpdated(string sentence)
    {
        SentenceSummary = sentence;
        SentenceWordCount = sentence.WordCount();
    }

    void ParagraphUpdated(string paragraph)
    {
        ParagraphSummary = paragraph;
        ParagraphWordCount = paragraph.WordCount();
    }

    void PageUpdated(string page)
    {
        PageSummary = page;
        PageWordCount = page.WordCount();
    }
}
