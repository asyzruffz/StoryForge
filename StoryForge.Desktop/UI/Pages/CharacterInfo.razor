@page "/characters/{id}"
@using StoryForge.Application.Characters
@using StoryForge.Application.Summaries
@using StoryForge.Core.Data
@using StoryForge.Core.Utils
@inject BreadCrumbHandler crumbHandler;
@inject NavigationManager navigationManager;
@inject ISender sender;

<PageTitle>@Title</PageTitle>
<MudText Typo="Typo.h4" Class="mb-4">@Title</MudText>

<MudStack Spacing="2">
    <MudTabs Rounded="true" Centered="true">
        <MudTabPanel Text="Basic Info" Class="pt-2">
            <MudStack Spacing="2">
                <MudTextField @bind-Value="CharacterName" Label="Name" Variant="Variant.Outlined" />
                <MudStack Row="true" Spacing="4">
                    <MudText Class="mr-4">Importance</MudText>
                    <MudSlider TickMarks="true" Min="0" Max="2" @bind-Value="ImportanceValue"></MudSlider>
                    <MudText>@Importance</MudText>
                    <div class="w-full"></div>
                </MudStack>
                <MudTextField @bind-Value="CharacterMotivation" Label="Motivation" Lines="3" Variant="Variant.Outlined" />
                <MudTextField @bind-Value="CharacterGoal" Label="Goal" Lines="3" Variant="Variant.Outlined" />
                <MudTextField @bind-Value="CharacterConflict" Label="Conflict" Lines="3" Variant="Variant.Outlined" />
                <MudTextField @bind-Value="CharacterEpiphany" Label="Epiphany" Lines="3" Variant="Variant.Outlined" />
            </MudStack>
        </MudTabPanel>
        <MudTabPanel Text="Summary" Class="pt-2">
            <MudStack Spacing="2">
                <MudTextField @bind-Value="SentenceSummary" Label="One-Sentence Summary" Lines="2" Variant="Variant.Outlined" />
                <MudTextField @bind-Value="ParagraphSummary" Label="One-Paragraph Summary" Lines="8" Variant="Variant.Outlined" />
                <MudTextField @bind-Value="PageSummary" Label="One-Page Summary" Lines="18" Variant="Variant.Outlined" />
            </MudStack>
        </MudTabPanel>
        <MudTabPanel Text="Notes" Class="pt-2">
            <MudTextField @bind-Value="Notes" Label="Notes" Lines="18" Variant="Variant.Outlined" />
        </MudTabPanel>
        <MudTabPanel Text="Detailed Info" Class="pt-2">
            <MudTextField @bind-Value="Details" Label="Details" Lines="18" Variant="Variant.Outlined" />
        </MudTabPanel>
    </MudTabs>
</MudStack>

@code {
    const string Title = "Character Information";

    [Parameter]
    public string Id { get; set; } = default!;

    string CharacterName
    {
        get => characterData?.Name ?? string.Empty;
        set
        {
            if (characterData is null) return;
            characterData.Name = value;
            SaveCharacter();
        }
    }

    int ImportanceValue
    {
        get => characterData?.Importance.Tier() ?? 0;
        set
        {
            if (characterData is null) return;
            characterData.Importance = (Importance)value;
            SaveCharacter();
        }
    }
    string Importance => characterData?.Importance.ToString() ?? string.Empty;

    string CharacterMotivation
    {
        get => characterData?.Motivation ?? string.Empty;
        set
        {
            if (characterData is null) return;
            characterData.Motivation = value;
            SaveCharacter();
        }
    }

    string CharacterGoal
    {
        get => characterData?.Goal ?? string.Empty;
        set
        {
            if (characterData is null) return;
            characterData.Goal = value;
            SaveCharacter();
        }
    }

    string CharacterConflict
    {
        get => characterData?.Conflict ?? string.Empty;
        set
        {
            if (characterData is null) return;
            characterData.Conflict = value;
            SaveCharacter();
        }
    }

    string CharacterEpiphany
    {
        get => characterData?.Epiphany ?? string.Empty;
        set
        {
            if (characterData is null) return;
            characterData.Epiphany = value;
            SaveCharacter();
        }
    }

    string SentenceSummary
    {
        get => characterData?.Summary.Sentence ?? string.Empty;
        set
        {
            if (characterData is null) return;
            characterData.Summary.Sentence = value;
            SaveSummary();
        }
    }

    string ParagraphSummary
    {
        get => characterData?.Summary.Paragraph ?? string.Empty;
        set
        {
            if (characterData is null) return;
            characterData.Summary.Paragraph = value;
            SaveSummary();
}
    }

    string PageSummary
    {
        get => characterData?.Summary.Page ?? string.Empty;
        set
        {
            if (characterData is null) return;
            characterData.Summary.Page = value;
            SaveSummary();
        }
    }

    string Notes
    {
        get => characterData?.Notes ?? string.Empty;
        set
        {
            if (characterData is null) return;
            characterData.Notes = value;
            SaveCharacter();
        }
    }

    string Details
    {
        get => characterData?.Details ?? string.Empty;
        set
        {
            if (characterData is null) return;
            characterData.Details = value;
            SaveCharacter();
        }
    }

    Character? characterData;

    protected override async Task OnInitializedAsync()
    {
        crumbHandler.Items.Clear();
        crumbHandler.Items.Add(new("Characters", "/characters", Icons.Material.Filled.People));
        crumbHandler.Items.Add(new(Title, $"/characters/{Id}", null));
        crumbHandler.NavigationChange?.Invoke();

        var characterResult = await sender.Send(new GetCharacterOperation(CharacterId.From(Id)));
        characterResult
            .Then(character =>
                {
                    characterData = character;
                    return Result<Character>.Ok(character);
                })
            .OnError(msg => navigationManager.NavigateTo("/error"));
    }

    void SaveCharacter()
    {
        if (characterData is null) return;
        _ = sender.Send(new UpdateCharacterOperation(characterData));
    }

    void SaveSummary()
    {
        if (characterData is null) return;
        _ = sender.Send(new UpdateSummaryOperation(characterData.Summary));
    }
}
