@using StoryForge.Application.Projects
@using StoryForge.Core.Data
@inject IDialogService dialogService;
@inject ISnackbar snackbar;
@inject NavigationManager navigationManager;
@inject ISender sender;

<Box Height="400px" Width="600px">
    <MudStack Row="true" Spacing="4" Class="mud-height-full align-stretch">
        <MudTable Items="RecentProjects" Hover="true" Dense="true" Height="100%" FixedHeader="true" Class="flex-grow-1">
            <HeaderContent>
                <MudTh><MudText Typo="Typo.h6">Recent projects</MudText></MudTh>
                <MudTh></MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.Name</MudTd>
                <MudTd></MudTd>
            </RowTemplate>
        </MudTable>
        <MudList T="string">
            <MudListItem Text="Create a new project" OnClick="CreateNewProject" Icon="@Icons.Material.Filled.NoteAdd" IconColor="Color.Primary" />
            <MudFileUpload T="IBrowserFile" @ref="@fileUpload" Accept=".db" FilesChanged="OnFileSelected">
                <ActivatorContent>
                    <MudListItem Text="Open a project" OnClick="OpenFilePicker" Icon="@Icons.Material.Filled.FileOpen" IconColor="Color.Primary" />
                </ActivatorContent>
            </MudFileUpload>
        </MudList>
    </MudStack>
</Box>

@code {
    MudFileUpload<IBrowserFile>? fileUpload;

    IEnumerable<Project> RecentProjects { get; set; } = [];

    protected override async Task OnInitializedAsync()
    {
        var projectsResult = await sender.Send(new GetRecentProjectsOperation());
        RecentProjects = projectsResult.Or([]);
    }

    async Task CreateNewProject()
    {
        var options = new DialogOptions() { MaxWidth = MaxWidth.Small, FullWidth = true, BackgroundClass = "blur-background" };
        var param = new DialogParameters<NewNameDialog>();
        param.Add(dlg => dlg.NameLabel, "Project Name");

        var dialog = await dialogService.ShowAsync<NewNameDialog>("Create New Project", param, options);
        DialogResult dialogResult = await dialog.Result ?? DialogResult.Cancel();
        if (dialogResult.Canceled) return;

        string projectName = dialogResult.Data?.ToString() ?? string.Empty;
        projectName = projectName.Trim();
        if (string.IsNullOrEmpty(projectName)) return;

        var projectResult = await sender.Send(new CreateProjectOperation(projectName));
        projectResult
            .OnError(msg => snackbar.Add(msg, Severity.Error))
            .Then(() => navigationManager.NavigateTo("/general", true));
    }

    async Task OpenProject(IBrowserFile file)
    {
        var projectResult = await sender.Send(new OpenProjectOperation(file.Name, file.OpenReadStream()));
        projectResult
            .OnError(msg => snackbar.Add(msg, Severity.Error))
            .Then(() => navigationManager.NavigateTo("/general", true));
    }

    async Task OpenFilePicker()
    {
        await (fileUpload?.OpenFilePickerAsync() ?? Task.CompletedTask);
    }

    void OnFileSelected(IBrowserFile file)
    {
        _ = OpenProject(file);
    }
}
