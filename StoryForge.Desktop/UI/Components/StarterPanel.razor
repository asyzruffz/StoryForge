@using StoryForge.Application.Projects
@using StoryForge.Core.Data
@inject IDialogService dialogService;
@inject ISnackbar snackbar;
@inject NavigationManager navigationManager;
@inject ISender sender;

<Box Height="400px" Width="800px">
    <MudStack Row="true" Spacing="4" Class="mud-height-full align-stretch">
        <MudTable T="Project" Items="@projects" GroupBy="@groupDefinition" OnRowClick="ProjectClicked"
                  Hover="true" Dense="true" Height="100%" FixedHeader="true"
                  Class="flex-grow-1" GroupHeaderClass="project-table-header">
            <ColGroup><col class="project-expander" /><col style="width:50%;" /><col /></ColGroup>
            <HeaderContent>
                <MudTh colspan="2"><MudText Typo="Typo.h6">Projects</MudText></MudTh>
                <MudTh></MudTh>
            </HeaderContent>
            <GroupHeaderTemplate>
                <MudTh colspan="2" Class="project-group-label">
                    <MudText Typo="Typo.subtitle2">@($"{((bool)context.Key! ? "Favourite" : "Recent")}")</MudText>
                </MudTh>
                <MudTh></MudTh>
            </GroupHeaderTemplate>
            <RowTemplate>
                <MudTd>
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.body1">@context.Name</MudText>
                        <MudText Typo="Typo.body2">@(context.FilePath.EllipsisMiddle(36))</MudText>
                    </MudStack>
                </MudTd>
                <MudTd>
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.body2">@context.LastActiveLocal.ToString("d")</MudText>
                        <MudText Typo="Typo.body2">@context.LastActiveLocal.ToString("T")</MudText>
                    </MudStack>
                </MudTd>
                <MudTd>
                    <MudToggleIconButton Toggled="@context.IsFavourite" Size="Size.Small"
                                         Icon="@Icons.Material.Filled.FavoriteBorder" Color="Color.Default"
                                         ToggledIcon="@Icons.Material.Filled.Favorite" ToggledColor="Color.Secondary" />
                </MudTd>
            </RowTemplate>
        </MudTable>

        <MudList T="string">
            <MudListItem Text="Create a new project" OnClick="CreateNewProject" Icon="@Icons.Material.Filled.NoteAdd" IconColor="Color.Primary" />
            <MudFileUpload T="IBrowserFile" @ref="@fileUpload" Accept=".db" FilesChanged="OnFileSelected">
                <ActivatorContent>
                    <MudListItem Text="Open a project" OnClick="OpenFilePicker" Icon="@Icons.Material.Filled.FileOpen" IconColor="Color.Primary" />
                </ActivatorContent>
            </MudFileUpload>
        </MudList>
    </MudStack>
</Box>

@code {
    MudFileUpload<IBrowserFile>? fileUpload;

    IEnumerable<Project> projects { get; set; } = [];

    TableGroupDefinition<Project> groupDefinition = new()
    {
        Indentation = false,
        Expandable = true,
        Selector = project => project.IsFavourite,
    };

    protected override async Task OnInitializedAsync()
    {
        var projectsResult = await sender.Send(new GetRecentProjectsOperation());
        projects = projectsResult.Or([]);
    }

    async Task CreateNewProject()
    {
        var options = new DialogOptions() { MaxWidth = MaxWidth.Small, FullWidth = true, BackgroundClass = "blur-background" };
        var param = new DialogParameters<NewNameDialog>();
        param.Add(dlg => dlg.NameLabel, "Project Name");

        var dialog = await dialogService.ShowAsync<NewNameDialog>("Create New Project", param, options);
        DialogResult dialogResult = await dialog.Result ?? DialogResult.Cancel();
        if (dialogResult.Canceled) return;

        string projectName = dialogResult.Data?.ToString() ?? string.Empty;
        projectName = projectName.Trim();
        if (string.IsNullOrEmpty(projectName)) return;

        var projectResult = await sender.Send(new CreateProjectOperation(projectName));
        projectResult
            .OnError(msg => snackbar.Add(msg, Severity.Error))
            .Then(() => navigationManager.NavigateTo("/general", true));
    }

    async Task OpenProject(IBrowserFile file)
    {
        var projectResult = await sender.Send(new OpenProjectFileOperation(file.Name, file.OpenReadStream()));
        projectResult
            .OnError(msg => snackbar.Add(msg, Severity.Error))
            .Then(() => navigationManager.NavigateTo("/general", true));
    }

    async Task OpenFilePicker()
    {
        await (fileUpload?.OpenFilePickerAsync() ?? Task.CompletedTask);
    }

    void OnFileSelected(IBrowserFile file)
    {
        _ = OpenProject(file);
    }

    async Task ProjectClicked(TableRowClickEventArgs<Project> evtArgs)
    {
        if (evtArgs.Item is null) return;
        var filePath = evtArgs.Item.FilePath;

        var projectResult = await sender.Send(new OpenProjectPathOperation(filePath));
        projectResult
            .OnError(msg => snackbar.Add(msg, Severity.Error))
            .Then(() => navigationManager.NavigateTo("/general", true));
    }
}
