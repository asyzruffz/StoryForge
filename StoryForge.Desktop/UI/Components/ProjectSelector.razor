@using StoryForge.Application.Projects
@inject IDialogService dialogService;
@inject ISnackbar snackbar;
@inject NavigationManager navigationManager;
@inject ISender sender;

<MudContainer Class="pa-3">
    <MudTooltip Text="Default Project of the Book" Disabled="@menuOpen">
    <MudButtonGroup Variant="Variant.Filled" FullWidth="true" OverrideStyles="false">
        <MudMenu Dense="true" Size="Size.Small" @bind-Open="menuOpen">
            <ActivatorContent>
                <MudButton Variant="Variant.Filled" Size="Size.Small" Class="pr-1">
                    <MudIcon Icon="@Icons.Material.Filled.Folder" Size="Size.Small" />
                    <MudIcon Icon="@Icons.Material.Filled.ArrowDropDown" />
                </MudButton>
            </ActivatorContent>
            <ChildContent>
                <MudMenuItem OnClick="CreateNewProject">New Project</MudMenuItem>
                <MudMenuItem OnClick="OpenFilePicker">
                    <MudFileUpload T="IBrowserFile" @ref="@fileUpload" Accept=".db" FilesChanged="OnFileSelected">
                        <ActivatorContent>
                            <MudLink Typo="Typo.body2" Color="Color.Default" Underline="Underline.None">Open Project</MudLink>
                        </ActivatorContent>
                    </MudFileUpload>
                </MudMenuItem>
                <MudMenuItem OnClick="CloseProject">Close Project</MudMenuItem>
            </ChildContent>
        </MudMenu>
        <MudButton Variant="Variant.Filled"
                   FullWidth="true"
                   Size="Size.Small"
                   Class="justify-start">
            <MudText Typo="Typo.body2" Align="Align.Start" Class="ellipsis-overflow" Style="margin-top:2px">
                <b>Default Project of the Book</b>
            </MudText>
        </MudButton>
    </MudButtonGroup>
    </MudTooltip>
</MudContainer>

@code {
    MudFileUpload<IBrowserFile>? fileUpload;
    bool menuOpen = false;

    async Task CreateNewProject()
    {
        var options = new DialogOptions() { MaxWidth = MaxWidth.Small, FullWidth = true, BackgroundClass = "blur-background" };
        var param = new DialogParameters<NewNameDialog>();
        param.Add(dlg => dlg.NameLabel, "Project Name");

        var dialog = await dialogService.ShowAsync<NewNameDialog>("Create New Project", param, options);
        DialogResult dialogResult = await dialog.Result ?? DialogResult.Cancel();
        if (dialogResult.Canceled) return;

        string projectName = dialogResult.Data?.ToString() ?? string.Empty;
        projectName = projectName.Trim();
        if (string.IsNullOrEmpty(projectName)) return;

        var projectResult = await sender.Send(new CreateProjectOperation(projectName));
        projectResult
            .OnError(msg => snackbar.Add(msg, Severity.Error))
            .Then(() => navigationManager.NavigateTo("/general", true));
    }

    async Task OpenProject(IBrowserFile file)
    {
        var projectResult = await sender.Send(new OpenProjectOperation(file.Name, file.OpenReadStream()));
        projectResult
            .OnError(msg => snackbar.Add(msg, Severity.Error))
            .Then(() => navigationManager.NavigateTo("/general", true));
    }

    async Task CloseProject()
    {
        var projectResult = await sender.Send(new CloseProjectOperation());
        projectResult
            .OnError(msg => snackbar.Add(msg, Severity.Error))
            .Then(() => navigationManager.NavigateTo("/", true));
    }

    async Task OpenFilePicker()
    {
        await (fileUpload?.OpenFilePickerAsync() ?? Task.CompletedTask);
    }

    void OnFileSelected(IBrowserFile file)
    {
        _ = OpenProject(file);
    }
}
